# YouTube・Instagramのダッシュボード・ランキング表示ロジックについて

## 1. はじめに

本レポートでは、ショート動画分析ダッシュボード「SHORTBOOSTER Creative Analyzer」における、YouTubeおよびInstagramのデータ表示ロジックについて詳細を説明します。

現在、TikTokのデータはダッシュボードやランキングに表示されていますが、YouTubeとInstagramについては、ハッシュタグの初期データが未登録のため、データ収集が行われておらず、画面上には表示されていません。しかし、システムとしては両プラットフォームに対応済みです。本レポートでは、ハッシュタグ登録後にデータがどのように収集・処理され、表示されるかを解説します。

## 2. 全体像

YouTubeおよびInstagramのデータ表示は、TikTokとほぼ同様のプロセスで行われます。主な流れは以下の通りです。

1.  **データ収集**: マスター管理画面から登録された各業種のプラットフォーム別（YouTube/Instagram）ハッシュタグに基づき、Apify社のWebクローラーを利用して動画データを収集します。
2.  **データ保存**: 収集した動画データを、プラットフォームを識別する情報（`platform: 'youtube'` または `platform: 'instagram'`）と共に`videos`テーブルに保存します。
3.  **自動タグ付け**: 保存された動画の投稿文やハッシュタグを基に、キーワードルールで「コンテンツタイプ」や「フックタイプ」などの分析用タグを付与し、`video_tags`テーブルに保存します。
4.  **データ表示**: ユーザーがダッシュボードやランキング画面でプラットフォーム（YouTube/Instagram）を選択すると、APIが`videos`テーブルから該当プラットフォームのデータのみを抽出し、画面に表示します。

以下に、各ステップの詳細を解説します。

## 3. データ収集・保存ロジック (`/api/collect-youtube`, `/api/collect-instagram`)

データ収集は、プラットフォームごとに専用のAPIエンドポイントが担当します。これらはVercel Cronによって毎日定時に自動実行されるほか、管理画面からの手動実行も可能です。

| プラットフォーム | APIエンドポイント | 使用するApifyアクター | 収集対象 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **YouTube** | `/api/collect-youtube` | `streamers~youtube-scraper` | YouTube Shorts | 60秒以下の動画、またはURLに`/shorts/`が含まれる動画のみを収集 |
| **Instagram** | `/api/collect-instagram` | `apify/instagram-reels-scraper` | Instagram Reels | `resultsType: "reels"` を指定してリール動画のみを収集 |

収集されたデータは、`videos`テーブルに保存されます。その際、各プラットフォームのデータ形式の違いを吸収し、共通のスキーマに正規化されます。特に重要な点は以下の通りです。

- **プラットフォーム識別子**: `platform`カラムに `'youtube'` または `'instagram'` という文字列を保存し、どのSNSのデータかを明確に区別します。
- **ユニークID**: 衝突を避けるため、YouTubeの動画IDには`yt_`、Instagramの動画IDには`ig_`というプレフィックスを付与した上で、`tiktokVideoId`カラムに保存しています。
- **エンゲージメント率(ER)の計算**: 各プラットフォームで取得できる指標が異なるため、ERの計算式が異なります。
    - **YouTube**: (いいね数 + コメント数) / 再生数  *(※シェア数はApifyから取得不可)*
    - **Instagram**: (いいね数 + コメント数 + シェア数) / 再生数

## 4. ダッシュボード・ランキングの表示ロジック

ダッシュボードとランキングの表示ロジックは、基本的に「**選択されたプラットフォームのデータのみをフィルタリングして表示する**」という点で共通しています。

### 4.1. ランキングページ (`/ranking`)

ランキングページは、動画の一覧を様々な条件でソート・フィルタリングして表示する機能です。

- **API**: フロントエンドは`/api/videos`というエンドポイントを呼び出します。
- **ロジック**: 
    1. ユーザーがUI上で「YouTube」または「Instagram」のボタンをクリックします。
    2. フロントエンドの状態（`platform`）が `'youtube'` または `'instagram'` に更新されます。
    3. `/api/videos`を呼び出す際に、`platform`パラメータを付与します (例: `/api/videos?platform=youtube`)。
    4. API側では、受け取った`platform`パラメータを使い、Prismaの`where`句で`videos`テーブルを`{ platform: 'youtube' }`のようにフィルタリングします。
    5. フィルタリングされた結果（指定されたプラットフォームの動画のみ）がフロントエンドに返却され、一覧表示されます。
    - ソート順（再生数、ERなど）や業種フィルタも同様にAPIパラメータとして渡され、`where`句や`orderBy`句に適用されます。

### 4.2. ダッシュボードページ (`/dashboard`)

ダッシュボードページは、業種全体のKPIや分析グラフを表示する機能です。

- **API**: フロントエンドは`/api/dashboard`というエンドポイントを呼び出します。
- **ロジック**: 
    1. ランキングページと同様に、ユーザーがUIでプラットフォームを選択します。
    2. `/api/dashboard`を呼び出す際に、`platform`パラメータを付与します (例: `/api/dashboard?industry_id=1&platform=instagram`)。
    3. API側では、指定された`industry_id`と`platform`で`videos`テーブルから動画データを取得します。
    4. 取得した動画データを基に、総再生数や平均ERなどのKPI、コンテンツタイプ別の統計などを計算します。
    5. 計算結果がフロントエンドに返却され、KPIカードやグラフとして描画されます。

## 5. 自動タグ付けとベンチマーク

データ収集後、以下の自動処理が実行されます。これらの処理もプラットフォームを横断して適用されます。

- **自動タグ付け (`/api/videos/auto-tag`)**: 収集された全プラットフォームの動画に対し、投稿文やハッシュタグを基にキーワードルールで分析用タグ（コンテンツタイプ、フックタイプ等）を付与します。このルールはプラットフォーム共通です。
- **ベンチマーク計算 (`/api/benchmarks/recalculate`)**: 各業種・プラットフォームごとに、平均ERや再生数の中央値などのベンチマーク指標を再計算し、`benchmarks`テーブルに保存します。

## 6. 結論と次のステップ

以上の通り、YouTubeおよびInstagramのデータ表示ロジックは既に実装済みであり、TikTokとほぼ同様の仕組みで動作します。

現在データが表示されないのは、**マスター管理画面からYouTube・Instagram用のハッシュタグが登録されていないため**です。各業種に対して適切なハッシュタグを登録し、データ収集（自動または手動）を実行することで、ダッシュボードとランキングにデータが反映されるようになります。

**次のステップ:**

1.  マスター管理者としてログインし、`/industries`ページにアクセスします。
2.  各業種の「編集」ボタンから、YouTubeおよびInstagramのタブを選択し、分析対象としたいハッシュタグを登録します。
3.  データ収集が実行されると（次回の定時実行、または手動での実行）、データが画面に表示されることを確認します。
